### 도커 이미지 레이어 


1. 도커 이미지 및 레이어 정의
	• 도커 이미지는 컨테이너를 생성하기 위한 파일 및 디렉토리의 레이어들을 포함하고 있으며, 이 레이어들은 결합되어 완전한 파일 시스템을 형성합니다.
	• 각 도커 이미지는 Dockerfile이라는 텍스트 파일에 명시된 지침(instructions)을 기반으로 빌드됩니다. 
		Dockerfile에는 도커 이미지를 어떻게 생성할지에 대한 단계별 지시사항이 포함되어 있습니다.

2. 레이어 생성 과정
	• 도커 이미지를 빌드하는 동안, 도커 엔진은 Dockerfile에 정의된 각 지침을 순서대로 실행합니다. 각 Dockerfile 지침은 이미지에 새로운 읽기 전용 레이어(read-only layer)를 생성합니다.
	• 예를 들어, docker build 명령을 실행하면 빌드 컨텍스트가 도커 데몬으로 전송되고, 
		FROM, ENV 등 각 Dockerfile 지시어가 실행될 때마다 
		내부적으로 중간 컨테이너가 생성 및 제거되면서 새로운 레이어가 추가됩니다. 
		빌드가 성공적으로 완료되면, Successfully built 메시지와 함께 이미지가 태그됩니다.
	• docker history <image_name> 명령을 사용하여 특정 이미지의 레이어 목록과 생성 정보(예: IMAGE, CREATED, CREATED BY, SIZE)를 확인할 수 있습니다.

3. 레이어의 이점 및 최적화
• 빌드 속도 향상 (캐싱):
    ◦ 도커는 이미지 빌드 과정에서 레이어 캐싱(caching) 메커니즘을 적극적으로 활용합니다. Dockerfile의 지침이 변경되지 않으면, 이전에 빌드된 해당 레이어를 재사용하여 빌드 시간을 크게 단축할 수 있습니다.
    ◦ 빌드 캐시와 이미지 레이어는 전반적인 빌드 시간을 개선하는 데 기여합니다.
• 이미지 크기 최적화:
    ◦ RUN 명령 결합: 여러 개의 RUN 명령을 && 심볼로 연결하여 하나의 RUN 지시어로 통합하면 이미지 크기를 줄이는 데 효과적입니다. 이는 각 RUN 명령이 별도의 레이어를 생성하는 것을 방지하여, 최종 이미지의 레이어 수를 최소화하기 때문입니다. 예를 들어, apt-get update와 apt-get install을 하나의 RUN 라인으로 묶는 것이 모범 사례로 권장됩니다.
    ◦ 멀티 스테이지 빌드 (Multi-Stage Builds): 멀티 스테이지 빌드는 도커 이미지 크기를 최적화하는 데 매우 강력한 방법입니다. 이 방식은 빌드에 필요한 도구와 런타임에 필요한 아티팩트를 분리하여, 최종 이미지에는 필수적인 런타임 구성 요소만 포함되도록 합니다. 이전에 사용되던 "빌더 패턴"은 두 개의 Dockerfile과 쉘 스크립트를 관리해야 하는 복잡성이 있었지만, 멀티 스테이지 빌드는 이를 하나의 Dockerfile 내에서 해결합니다. 이를 통해 800MB가 넘는 Golang 빌드 이미지를 **수 MB (예: 7.6MB, 2.01MB, 13.1MB)**로 줄이는 것과 같이 이미지 크기를 극적으로 줄일 수 있습니다.
    ◦ FROM scratch: scratch는 가장 기본적인 베이스 이미지로, 완전히 빈 이미지에서 시작하여 애플리케이션의 바이너리 파일과 최소한의 런타임 의존성만을 포함하는 매우 작은 이미지를 생성하는 데 사용됩니다.
    ◦ --squash 옵션: docker build 명령의 --squash 옵션은 모든 레이어를 단일 레이어로 병합하여 이미지 크기를 줄이는 실험적인 기능입니다.
    ◦ 최소 이미지 크기 권장: 프로덕션 환경에서는 빌드, 배포, 푸시, 풀 시간을 단축하기 위해 최소 크기의 도커 이미지를 생성하는 것이 중요합니다.
4. 기타 레이어 관련 지침 및 개념
	• LABEL 지시어: Dockerfile에서 MAINTAINER 지시어는 더 이상 사용되지 않으며, 대신 LABEL 지시어를 사용하여 이미지의 작성자나 버전에 대한 메타데이터(key-value 쌍)를 추가할 수 있습니다.
	• 빌드 패턴 성숙도: 이미지 빌드 패턴은 사용 사례에 따라 다양하게 진화했습니다. 내부 실험이나 개발 환경에서는 "All-in-One" 패턴이 적합할 수 있지만, 서버 배포와 같이 이미지를 배포할 때는 "Build + Multiple Runtimes"와 같은 더 성숙한 패턴이 권장됩니다.
5.  명령과 레이어
• docker images ls --digests: 이미지의 다이제스트(고유 식별자)를 포함하여 이미지를 나열합니다. 이는 특정 이미지의 내용이 변경되지 않았음을 확인하는 데 유용합니다.
• docker build -t <image_name> .: 현재 디렉토리의 Dockerfile을 사용하여 이미지를 빌드하고 태그를 지정합니다.
• docker run --name my_first_container busybox:latest: 특정 이미지를 기반으로 컨테이너를 실행합니다. 여기서 busybox:latest는 사용할 이미지와 태그를 나타냅니다.

